name: Smart Fetch & Compare

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨GitHubé¡µé¢ä¸Šç‚¹å‡»è¿è¡Œï¼‰
  workflow_dispatch:
    inputs:
      source_url:
        description: 'æºæ–‡ä»¶URLï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é…ç½®ï¼‰'
        required: false
        default: ''
      target_path:
        description: 'ä¿å­˜è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤worker.jsï¼‰'
        required: false
        default: 'worker.js'
  
  # å®šæ—¶è‡ªåŠ¨æ£€æŸ¥ï¼ˆæ¯å¤©UTC 8ç‚¹è¿è¡Œï¼ŒåŒ—äº¬æ—¶é—´16ç‚¹ï¼‰
  schedule:
    - cron: '0 8 * * *'
  
  # æ¨é€è§¦å‘ï¼ˆå½“é…ç½®æ›´æ–°æ—¶è¿è¡Œï¼‰
  push:
    paths:
      - '.github/workflows/smart-fetch.yml'
      - 'fetch-config.json'

jobs:
  smart-fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æäº¤æ–‡ä»¶
    
    steps:
    - name: 1ï¸âƒ£ æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
    
    - name: 2ï¸âƒ£ åŠ è½½é…ç½®
      id: config
      run: |
        # åˆ›å»ºé…ç½®
        cat > fetch-config.json << 'EOF'
        {
          "source_url": "${{ github.event.inputs.source_url || secrets.FETCH_SOURCE_URL || 'https://raw.githubusercontent.com/example/worker/main/worker.js' }}",
          "target_path": "${{ github.event.inputs.target_path || 'worker.js' }}",
          "commit_message": "ğŸ”„ Auto-update: {filename} [æ™ºèƒ½åŒæ­¥]",
          "compare_method": "content_hash",
          "ignore_whitespace": true,
          "notify_on_change": false
        }
        EOF
        
        # è¯»å–é…ç½®
        SOURCE_URL=$(jq -r '.source_url' fetch-config.json)
        TARGET_PATH=$(jq -r '.target_path' fetch-config.json)
        
        echo "ğŸ”§ é…ç½®åŠ è½½å®Œæˆ"
        echo "ğŸ“¥ æºæ–‡ä»¶: $SOURCE_URL"
        echo "ğŸ’¾ ç›®æ ‡è·¯å¾„: $TARGET_PATH"
        
        echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT
        echo "target_path=$TARGET_PATH" >> $GITHUB_OUTPUT
    
    - name: 3ï¸âƒ£ æ‹‰å–æºæ–‡ä»¶
      id: fetch
      run: |
        echo "ğŸ“¥ å¼€å§‹æ‹‰å–æ–‡ä»¶..."
        echo "URL: ${{ steps.config.outputs.source_url }}"
        
        # ä½¿ç”¨curlä¸‹è½½æ–‡ä»¶
        curl -s -L -o "new_content.tmp" "${{ steps.config.outputs.source_url }}"
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ ! -f "new_content.tmp" ]; then
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        # è®¡ç®—æ–‡ä»¶ä¿¡æ¯
        FILE_SIZE=$(wc -c < "new_content.tmp")
        LINE_COUNT=$(wc -l < "new_content.tmp")
        CONTENT_HASH=$(sha256sum "new_content.tmp" | cut -d' ' -f1)
        
        echo "âœ… æ–‡ä»¶æ‹‰å–æˆåŠŸ"
        echo "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "ğŸ“ è¡Œæ•°: $LINE_COUNT"
        echo "ğŸ” å“ˆå¸Œå€¼: $CONTENT_HASH"
        
        echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
        echo "content_hash=$CONTENT_HASH" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºæ–‡ä»¶å‰5è¡Œé¢„è§ˆ
        echo "ğŸ“„ å†…å®¹é¢„è§ˆ:"
        head -5 "new_content.tmp"
    
    - name: 4ï¸âƒ£ ä¸ç°æœ‰æ–‡ä»¶å¯¹æ¯”
      id: compare
      run: |
        TARGET_PATH="${{ steps.config.outputs.target_path }}"
        
        # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$TARGET_PATH" ]; then
          echo "ğŸ“ æ‰¾åˆ°ç°æœ‰æ–‡ä»¶: $TARGET_PATH"
          
          # è®¡ç®—ç°æœ‰æ–‡ä»¶çš„å“ˆå¸Œ
          EXISTING_HASH=$(sha256sum "$TARGET_PATH" | cut -d' ' -f1)
          echo "ğŸ”‘ ç°æœ‰æ–‡ä»¶å“ˆå¸Œ: $EXISTING_HASH"
          
          # è®¡ç®—æ–°æ–‡ä»¶çš„å“ˆå¸Œ
          NEW_HASH="${{ steps.fetch.outputs.content_hash }}"
          echo "ğŸ†• æ–°æ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"
          
          # å¯¹æ¯”å“ˆå¸Œå€¼
          if [ "$EXISTING_HASH" = "$NEW_HASH" ]; then
            echo "âœ… æ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼Œæ— éœ€æ›´æ–°"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_type=no_change" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ å‘ç°å·®å¼‚ï¼Œéœ€è¦æ›´æ–°"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_type=content_updated" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºå·®å¼‚ï¼ˆå‰10è¡Œï¼‰
            echo "ğŸ“Š å†…å®¹å·®å¼‚é¢„è§ˆ:"
            diff -u "$TARGET_PATH" "new_content.tmp" | head -20 || echo "ï¼ˆè¿™æ˜¯æ–°æ–‡ä»¶æˆ–å®Œå…¨ä¸åŒçš„æ–‡ä»¶ï¼‰"
          fi
        else
          echo "ğŸ“­ ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "change_type=new_file" >> $GITHUB_OUTPUT
        fi
    
    - name: 5ï¸âƒ£ ä¿å­˜æ–‡ä»¶ï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
      if: steps.compare.outputs.has_changes == 'true'
      run: |
        TARGET_PATH="${{ steps.config.outputs.target_path }}"
        CHANGE_TYPE="${{ steps.compare.outputs.change_type }}"
        
        # å¤‡ä»½æ—§æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "$TARGET_PATH" ]; then
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_PATH="backups/${TARGET_PATH}.bak_${TIMESTAMP}"
          mkdir -p backups
          cp "$TARGET_PATH" "$BACKUP_PATH"
          echo "ğŸ’¾ å·²åˆ›å»ºå¤‡ä»½: $BACKUP_PATH"
        fi
        
        # ç§»åŠ¨æ–°æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½®
        mv "new_content.tmp" "$TARGET_PATH"
        
        # è®¾ç½®æ–‡ä»¶ä¿¡æ¯
        case $CHANGE_TYPE in
          "new_file")
            COMMIT_MSG="âœ¨ æ–°å¢æ–‡ä»¶: $TARGET_PATH"
            ;;
          "content_updated")
            COMMIT_MSG="ğŸ”„ æ›´æ–°æ–‡ä»¶: $TARGET_PATH"
            ;;
          *)
            COMMIT_MSG="ğŸ“ æ›´æ–°æ–‡ä»¶: $TARGET_PATH"
            ;;
        esac
        
        # æ·»åŠ æ—¶é—´æˆ³å’Œè¯¦ç»†ä¿¡æ¯
        COMMIT_MSG="$COMMIT_MSG
        æ–‡ä»¶å¤§å°: ${{ steps.fetch.outputs.file_size }} å­—èŠ‚
        æ–‡ä»¶è¡Œæ•°: ${{ steps.fetch.outputs.line_count }}
        å†…å®¹å“ˆå¸Œ: ${{ steps.fetch.outputs.content_hash }}
        æ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S %Z')"
        
        echo "âœ… æ–‡ä»¶å·²ä¿å­˜åˆ°: $TARGET_PATH"
        echo "ğŸ“ æäº¤ä¿¡æ¯:"
        echo "$COMMIT_MSG"
        
        echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: 6ï¸âƒ£ æäº¤åˆ°GitHubï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
      if: steps.compare.outputs.has_changes == 'true'
      run: |
        echo "ğŸš€ å¼€å§‹æäº¤å˜æ›´åˆ°GitHub..."
        
        # é…ç½®Gitç”¨æˆ·
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions@users.noreply.github.com"
        
        # æ·»åŠ æ–‡ä»¶
        git add "${{ steps.config.outputs.target_path }}"
        
        # æäº¤
        git commit -m "${{ steps.compare.outputs.commit_msg }}"
        
        # æ¨é€
        git push origin main
        
        echo "ğŸ‰ æˆåŠŸæäº¤å¹¶æ¨é€å˜æ›´ï¼"
        echo "ğŸ“Š æäº¤å“ˆå¸Œ: $(git rev-parse --short HEAD)"
    
    - name: 7ï¸âƒ£ ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ========== æ‰§è¡ŒæŠ¥å‘Š =========="
        echo "ğŸ• æ‰§è¡Œæ—¶é—´: $(date)"
        echo "ğŸ“¥ æºæ–‡ä»¶: ${{ steps.config.outputs.source_url }}"
        echo "ğŸ’¾ ç›®æ ‡è·¯å¾„: ${{ steps.config.outputs.target_path }}"
        echo "ğŸ“Š æ–‡ä»¶å¤§å°: ${{ steps.fetch.outputs.file_size }} å­—èŠ‚"
        echo "ğŸ“ æ–‡ä»¶è¡Œæ•°: ${{ steps.fetch.outputs.line_count }}"
        echo "ğŸ” å†…å®¹å“ˆå¸Œ: ${{ steps.fetch.outputs.content_hash }}"
        echo "ğŸ”„ å˜æ›´çŠ¶æ€: ${{ steps.compare.outputs.has_changes == 'true' && 'æœ‰å˜æ›´ï¼Œå·²æäº¤' || 'æ— å˜æ›´ï¼Œå·²è·³è¿‡' }}"
        
        if [ "${{ steps.compare.outputs.has_changes }}" = "true" ]; then
          echo "âœ… ç»“æœ: æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤åˆ°ä»“åº“"
        else
          echo "â­ï¸  ç»“æœ: æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
        echo "================================="
    
    - name: 8ï¸âƒ£ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f new_content.tmp
        echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
